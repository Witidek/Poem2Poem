{{extend 'layout.html'}}

<h2>{{=poem.title}}</h2>
{{addRhyme = False}}
</br>
<pre>{{=poem.body}}{{if rows:}}{{for row in rows:}}</br>{{=row.line}}{{if row.line_number % 4 == 0 and 16 > row.line_number:}}</br> {{pass}}{{pass}}{{pass}}</pre>
Author: {{=db.auth_user(poem.author).username}}
</br>
{{if (poem.line_count+1) % 4 == 1 or (poem.line_count+1) % 4 == 2 :}} {{addRhyme = True}} {{pass}}
{{if addRhyme == False:}}
<h2>Add a line to this poem</h2>
{{elif addRhyme == True:}}
<h2>Add a line to this poem</h2>
<h2>Start a New Rhyme</h2>
{{pass}}

{{=form}}
{{if addRhyme == False:}}
<table class="table">
  <col width="500">
    <tr>
        <th>Words that rhyme with {{=rhyme_word}}</th>
        <th>Syllables</th>
    </tr>
    <tr>
     {{for i ,row in enumerate(parsed_json):}}
        {{if 50 > i:}}
        <td>{{= parsed_json[i]['word']}}</td>
        <td>{{= parsed_json[i]['syllables']}}</td>
        {{pass}}
    </tr>
    {{pass}}
{{pass}}

<script language="JavaScript">
$(document).ready(function(){
    setTimeout("window.location.href='{{=URL('poem', args=poem.id)}}';",60000);

    var _wasPageCleanedUp = false;
    function pageCleanup()
    {
        if (!_wasPageCleanedUp)
        {
            $.ajax({
                type: 'GET',
                async: false,
                url: '{{=URL('unlock_mutex', args=poem.id)}}',
                success: function ()
                {
                    _wasPageCleanedUp = true;
                }
            });
        }
    }


    $(window).on('beforeunload', function ()
    {
        //this will work only for Chrome
        pageCleanup();
    });

    $(window).on("unload", function ()
    {
        //this will work for other browsers
        pageCleanup();
    });
});
</script>
